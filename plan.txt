I've created a comprehensive implementation plan. Here's the document:
---
Performance Optimization Implementation Plan
Overview
This document provides a comprehensive plan for fixing the slow data fetching and rendering issues in the Next.js personnel database web application.
---
Executive Summary
Current Problems:
- Large Base64 PDF payloads in every API response
- No pagination - loads ALL records at once
- Multiple components fetch identical data independently
- SELECT * queries fetching unnecessary columns
- Client-side only data fetching pattern
---
Phase 1: API Optimization (Critical)
Task 1.1: Remove Base64 Encoding from List APIs
Files to Modify:
- /home/ervnmrcdo/CS19X/personnel_database/pages/api/pendingAwards.ts
- /home/ervnmrcdo/CS19X/personnel_database/pages/api/admin/get-all-awards/route.ts
- /home/ervnmrcdo/CS19X/personnel_database/pages/api/get/accepted-forms.ts
- /home/ervnmrcdo/CS19X/personnel_database/pages/api/get/rejected-forms.ts
Change:
// Before
pdfBase64: r.attached_files
  ? Buffer.from(r.attached_files).toString("base64")
  : null,
// After  
hasFile: !!r.attached_files,
fileUrl: `/api/files/${r.submission_id}`
New endpoint to create:
- /home/ervnmrcdo/CS19X/personnel_database/pages/api/files/[submissionId].ts - serves individual PDF files
---
Task 1.2: Implement Server-Side Pagination
Files to Modify:
- /home/ervnmrcdo/CS19X/personnel_database/pages/api/pendingAwards.ts
- /home/ervnmrcdo/CS19X/personnel_database/pages/api/admin/get-all-awards/route.ts
Add query params: page (default 1), limit (default 20)
SQL Changes:
LIMIT $limit OFFSET $offset
-- with ORDER BY date_submitted DESC
Return format:
{
  data: Award[],
  pagination: { page, limit, totalCount, totalPages, hasNextPage, hasPrevPage }
}
---
Task 1.3: Optimize SELECT Queries
Replace SELECT * with explicit column lists in all API files.
---
Phase 2: React Query Implementation
Task 2.1: Install Dependencies
npm install @tanstack/react-query @tanstack/react-query-devtools
Task 2.2: Create Provider
File: /home/ervnmrcdo/CS19X/personnel_database/providers/QueryProvider.tsx
"use client";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { useState } from "react";
export default function QueryProvider({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 60 * 1000,
        gcTime: 5 * 60 * 1000,
        refetchOnWindowFocus: false,
      },
    },
  }));
  return <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>;
}
Task 2.3: Wrap Application
File: /home/ervnmrcdo/CS19X/personnel_database/app/layout.tsx
import QueryProvider from "@/providers/QueryProvider";
// Wrap: <QueryProvider><AuthProvider>{children}</AuthProvider></QueryProvider>
Task 2.4: Create Custom Hook
File: /home/ervnmrcdo/CS19X/personnel_database/hooks/useAwards.ts
import { useQuery } from "@tanstack/react-query";
export function usePendingAwards() {
  return useQuery({
    queryKey: ["awards", "pending"],
    queryFn: async () => {
      const res = await fetch("/api/pendingAwards?page=1&limit=20");
      if (!res.ok) throw new Error("Failed");
      return res.json();
    },
  });
}
Task 2.5: Refactor Components
- /home/ervnmrcdo/CS19X/personnel_database/components/AllAwards.tsx
- /home/ervnmrcdo/CS19X/personnel_database/components/Dashboard/AdminDashboard.tsx
Replace useEffect + fetch with useQuery hooks.
---
Phase 3: Database Indexes
File: /home/ervnmrcdo/CS19X/personnel_database/migrations/add-performance-indexes.sql
CREATE INDEX IF NOT EXISTS idx_pendingawards_status ON PendingAwards(status);
CREATE INDEX IF NOT EXISTS idx_pendingawards_date_submitted ON PendingAwards(date_submitted DESC);
CREATE INDEX IF NOT EXISTS idx_pendingawards_status_date ON PendingAwards(status, date_submitted DESC);
CREATE INDEX IF NOT EXISTS idx_publications_teaching_id ON Publications(teaching_id);
CREATE INDEX IF NOT EXISTS idx_publications_nonteaching_id ON Publications(nonteaching_id);
Run against your Neon PostgreSQL database.
---
Phase 4: Skeleton Loading States
File: /home/ervnmrcdo/CS19X/personnel_database/components/UI/Skeleton.tsx
export function SkeletonTable({ rows = 5 }: { rows?: number }) {
  return (
    <div className="space-y-3">
      <div className="grid grid-cols-6 gap-4">
        {[...Array(6)].map((_, i) => (
          <div key={i} className="h-4 bg-gray-200 rounded animate-pulse" />
        ))}
      </div>
      {[...Array(rows)].map((_, rowIndex) => (
        <div key={rowIndex} className="grid grid-cols-6 gap-4 py-3 border-t">
          {[...Array(6)].map((_, colIndex) => (
            <div key={colIndex} className="h-4 bg-gray-100 rounded animate-pulse" />
          ))}
        </div>
      ))}
    </div>
  );
}
Use in components:
const { data, isLoading } = useAllAwards();
if (isLoading) return <SkeletonTable rows={10} />;
---
Phase 5: File Download Endpoint
File: /home/ervnmrcdo/CS19X/personnel_database/pages/api/files/[submissionId].ts
import sql from "@/config/db";
import { NextApiRequest, NextApiResponse } from "next";
export default async function GetFile(req: NextApiRequest, res: NextApiResponse) {
  const { submissionId } = req.query;
  
  const rows = await sql`
    SELECT attached_files, mime_type FROM PendingAwards
    WHERE submission_id = ${submissionId}
  `;
  if (!rows[0]?.attached_files) {
    return res.status(404).json({ error: "Not found" });
  }
  res.setHeader("Content-Type", rows[0].mime_type || "application/pdf");
  res.setHeader("Content-Disposition", `attachment; filename="submission-${submissionId}.pdf"`);
  return res.send(Buffer.from(rows[0].attached_files));
}
---
Phase 6: Update Display Components
Replace inline Base64 PDFs with download links:
{hasFile && (
  <a href={`/api/files/${id}`} target="_blank" className="text-blue-600 hover:underline">
    View Document
  </a>
)}
---
Files Summary
| Phase | Create | Modify |
|-------|--------|--------|
| 1 | - | pages/api/pendingAwards.ts, pages/api/admin/get-all-awards/route.ts |
| 2 | providers/QueryProvider.tsx, hooks/useAwards.ts | app/layout.tsx, components/AllAwards.tsx, AdminDashboard.tsx |
| 3 | migrations/add-performance-indexes.sql | - |
| 4 | components/UI/Skeleton.tsx | - |
| 5 | pages/api/files/[submissionId].ts | - |
| 6 | - | components/Review/ListedApplications.tsx |
---
Dependencies
npm install @tanstack/react-query @tanstack/react-query-devtools
---
Estimated Time: 8-11 hours
---
Questions for Clarification
1. Database Access: Can you run the SQL migration directly, or need a script?
2. React Query: v4 or v5?
3. Page Size: Default to 20? (adjustable)
4. File Storage: Confirm files are stored as BYTEA in PostgreSQL?
5. Tests: Add unit tests for pagination logic?
---
